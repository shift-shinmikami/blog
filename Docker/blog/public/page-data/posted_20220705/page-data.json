{"componentChunkName":"component---src-templates-blog-post-js","path":"/posted_20220705/","result":{"data":{"site":{"siteMetadata":{"title":"Shin-tech25's Blog"}},"markdownRemark":{"id":"73a92fff-f448-5935-9577-b52c615aba39","excerpt":"このページでは、保守的な Playbook の書き方、冪等性などをしっかりと考慮した Playbook や tips を紹介しています。シンプルでクリーンな Playbook を作成しましょう。 Ansible は Red Hat 社により開発されているサーバプロビジョニング・ツールです。Linux…","html":"<p>このページでは、保守的な Playbook の書き方、冪等性などをしっかりと考慮した Playbook や tips を紹介しています。シンプルでクリーンな Playbook を作成しましょう。</p>\n<p>Ansible は Red Hat 社により開発されているサーバプロビジョニング・ツールです。Linux を始めとして、Windows、Cisco 機器などに対しても設定変更を行うことができます。汎用性が高いことがメリットです。</p>\n<p>一方、設計段階で Playbook( = Ansible 実行コード)の設計方針をしっかりと決めなければ、Playbook と処理の対応関係が次第に分かりづらくなり、保守に時間がかかるコードを量産してしまうことに繋がります。</p>\n<p>業務で実際に複雑な Playbook を見てきました。見ただけでは実際に何をする処理なのか分かりづらく、ミスの温床になります。</p>\n<p>そういった Playbook を作らないためにどうしたら良いか。以下に記載しました。</p>\n<h2>概要</h2>\n<p>保守的な Playbook を考える上でも観点はいくつかあります。\r\nその中でも特に重要な観点を以下に挙げました。</p>\n<ul>\n<li>トップダウン設計</li>\n<li>インベントリ設計</li>\n<li>ドライランチェック</li>\n<li>冪等性</li>\n<li>変数の設計</li>\n</ul>\n<p>について挙げていきます。</p>\n<h3>トップダウン設計</h3>\n<p>Playbook の設計で最も重視すべきなのがこのトップダウン設計です。</p>\n<ul>\n<li>site.yml</li>\n<li>各種 Playbook</li>\n<li>role</li>\n</ul>\n<p>この順番に Playbook を記述していきます。実際の処理(Task)は、role にだけ記述します。<code class=\"language-text\">site.yml</code>や Playbook には、対応関係のみを記述します。こうすることで、メンテナンスしやすくなります。</p>\n<p><code class=\"language-text\">site.yml</code>は以下のように、Playbook を<code class=\"language-text\">import_playbook</code>により import します。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\r\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Linuxの共通設定(all)\r\n  <span class=\"token key atrule\">import_playbook</span><span class=\"token punctuation\">:</span> linux<span class=\"token punctuation\">-</span>common.yml\r\n\r\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Manager 用の設定\r\n  <span class=\"token key atrule\">import_playbook</span><span class=\"token punctuation\">:</span> manager.yml\r\n\r\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Staging用の設定\r\n  <span class=\"token key atrule\">import_playbook</span><span class=\"token punctuation\">:</span> staging.yml\r\n\r\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Production用の設定\r\n  <span class=\"token key atrule\">import_playbook</span><span class=\"token punctuation\">:</span> production.yml</code></pre></div>\n<p>各種 Playbook は以下のように、<code class=\"language-text\">role</code> を用いて処理を記述していきます。なお、<code class=\"language-text\">role</code>は<code class=\"language-text\">roles</code>の下にネストして、<code class=\"language-text\">tags</code>を付与します。\r\nこのようにすることで、<code class=\"language-text\">role</code>の局所的使用を可能にします。</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">---</span>\r\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Linux の共通設定用の Playbook\r\n  <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span> linux\r\n  <span class=\"token key atrule\">become</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n  <span class=\"token key atrule\">gather_facts</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\r\n\r\n  <span class=\"token key atrule\">roles</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token comment\"># ホスト名変更</span>\r\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">role</span><span class=\"token punctuation\">:</span> change_hostname\r\n    <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span> change_hostname\r\n\r\n  <span class=\"token comment\"># 共通パッケージインストール</span>\r\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">role</span><span class=\"token punctuation\">:</span> linux_common_packages\r\n    <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span> linux_common_packages\r\n\r\n  <span class=\"token comment\"># firewalld 有効化と設定</span>\r\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">role</span><span class=\"token punctuation\">:</span> firewalld_setup\r\n    <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span> firewalld_setup\r\n\r\n  <span class=\"token comment\"># sshd 有効化と設定</span>\r\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">role</span><span class=\"token punctuation\">:</span> sshd\r\n    <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span> sshd\r\n\r\n  <span class=\"token comment\"># docker インストール</span>\r\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">role</span><span class=\"token punctuation\">:</span> install_docker\r\n    <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span> install_docker\r\n\r\n  <span class=\"token comment\"># SELinux 無効化と必要なら再起動</span>\r\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">role</span><span class=\"token punctuation\">:</span> selinux\r\n    <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span> selinux</code></pre></div>\n<p>図にすると以下のようになります。\r\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d90c01beefc6ce9a680a8b11eea879c1/b3058/Playbook%E3%83%88%E3%83%83%E3%83%97%E3%83%80%E3%82%A6%E3%83%B3%E8%A8%AD%E8%A8%88.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.49367088607595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3pQB/8QAFhABAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAEBAAEFAkTIj//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABcQAQEBAQAAAAAAAAAAAAAAAAAxARD/2gAIAQEAAT8h4hc1CH//2gAMAwEAAgADAAAAEODP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHBABAAIBBQAAAAAAAAAAAAAAAQARURAhgbHR/9oACAEBAAE/EG0bK5mXs74O4yyrag0f/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Playbookトップダウン設計\"\n        title=\"Playbookトップダウン設計\"\n        src=\"/static/d90c01beefc6ce9a680a8b11eea879c1/828fb/Playbook%E3%83%88%E3%83%83%E3%83%97%E3%83%80%E3%82%A6%E3%83%B3%E8%A8%AD%E8%A8%88.jpg\"\n        srcset=\"/static/d90c01beefc6ce9a680a8b11eea879c1/ff44c/Playbook%E3%83%88%E3%83%83%E3%83%97%E3%83%80%E3%82%A6%E3%83%B3%E8%A8%AD%E8%A8%88.jpg 158w,\n/static/d90c01beefc6ce9a680a8b11eea879c1/a6688/Playbook%E3%83%88%E3%83%83%E3%83%97%E3%83%80%E3%82%A6%E3%83%B3%E8%A8%AD%E8%A8%88.jpg 315w,\n/static/d90c01beefc6ce9a680a8b11eea879c1/828fb/Playbook%E3%83%88%E3%83%83%E3%83%97%E3%83%80%E3%82%A6%E3%83%B3%E8%A8%AD%E8%A8%88.jpg 630w,\n/static/d90c01beefc6ce9a680a8b11eea879c1/0ede0/Playbook%E3%83%88%E3%83%83%E3%83%97%E3%83%80%E3%82%A6%E3%83%B3%E8%A8%AD%E8%A8%88.jpg 945w,\n/static/d90c01beefc6ce9a680a8b11eea879c1/3ac88/Playbook%E3%83%88%E3%83%83%E3%83%97%E3%83%80%E3%82%A6%E3%83%B3%E8%A8%AD%E8%A8%88.jpg 1260w,\n/static/d90c01beefc6ce9a680a8b11eea879c1/b3058/Playbook%E3%83%88%E3%83%83%E3%83%97%E3%83%80%E3%82%A6%E3%83%B3%E8%A8%AD%E8%A8%88.jpg 1296w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>インベントリ設計</h3>\n<p>以下に YAML 形式でのインベントリを例として記載しました。</p>\n<p>YAML 形式では、<code class=\"language-text\">children:</code>の下に位置するグループがその上のグループに所属することになります。また、<code class=\"language-text\">hosts:</code>の下に位置するホストがその上のグループに所属することになります。</p>\n<p>例えば、グループ<code class=\"language-text\">manager</code>、<code class=\"language-text\">staging</code>、<code class=\"language-text\">production</code>は<code class=\"language-text\">linux</code>グループに所属しており、同時に<code class=\"language-text\">all</code>に所属しています。（<code class=\"language-text\">all</code>は特別なグループで全てのホストが必ずこれに属しています。）<code class=\"language-text\">staging001.ga</code>、<code class=\"language-text\">test003.ga</code>、<code class=\"language-text\">test004.ga</code>は<code class=\"language-text\">staging</code>グループと<code class=\"language-text\">all</code>グループに所属しています。</p>\n<p>hosts.yml</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">all</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">children</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">linux</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token key atrule\">children</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">manager</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">staging</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">production</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">manager</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">manager001.ga</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">staging</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">staging001.ga</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">test003.ga</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">test004.ga</span><span class=\"token punctuation\">:</span>\r\n        <span class=\"token key atrule\">test005.ga</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">production</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span>\r\n        production001.ga<span class=\"token punctuation\">:</span></code></pre></div>\n<p>ホストやグループの変数（Inventory Variables）は、<code class=\"language-text\">host_vars/</code>、<code class=\"language-text\">group_vars/</code>の下にそれぞれのホストやグループの名前を冠した YAML ファイルを配置し記載します。</p>\n<p>以下にディレクトリ構造の例を記載します。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Ansible/\r\n  inventory/\r\n    group_vars/\r\n      all.yml\r\n      manager.yml\r\n      production.yml\r\n      staging.yml\r\n    host_vars/\r\n      manager001.ga.yml\r\n      production001.ga.yml\r\n      staging001.ga.yml\r\n      test003.ga.yml\r\n      test004.ga.yml\r\n      test005.ga.yml\r\n    hosts.yml</code></pre></div>\n<p>グループも意識しないと沢山出来てしまいますが、原則として「一つの Playbook には、一つのグループが紐づく」ことを意識すると沢山のグループを作らずに済み可読性が上がります。グループには役割や機能を抽象化したものを記載すると分かりやすいです。例えば、Zabbix サーバなら zabbix グループという具合に。</p>\n<p>今回の例で、インベントリの設計を図にしたものが以下になります。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ecf23d3e43543dbffdc25988c10376ab/e7cb9/%E3%82%A4%E3%83%B3%E3%83%99%E3%83%B3%E3%83%88%E3%83%AA%E8%A8%AD%E8%A8%88.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.59493670886076%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAd+aQig//8QAFxAAAwEAAAAAAAAAAAAAAAAAAAEgQf/aAAgBAQABBQIxR//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABcQAAMBAAAAAAAAAAAAAAAAAAABMRD/2gAIAQEAAT8hGJxQUP/aAAwDAQACAAMAAAAQMw//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAaEAEBAAMBAQAAAAAAAAAAAAABABEhMYHw/9oACAEBAAE/EFU5j2+M5lem4CNEA0L/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"インベントリ設計\"\n        title=\"インベントリ設計\"\n        src=\"/static/ecf23d3e43543dbffdc25988c10376ab/828fb/%E3%82%A4%E3%83%B3%E3%83%99%E3%83%B3%E3%83%88%E3%83%AA%E8%A8%AD%E8%A8%88.jpg\"\n        srcset=\"/static/ecf23d3e43543dbffdc25988c10376ab/ff44c/%E3%82%A4%E3%83%B3%E3%83%99%E3%83%B3%E3%83%88%E3%83%AA%E8%A8%AD%E8%A8%88.jpg 158w,\n/static/ecf23d3e43543dbffdc25988c10376ab/a6688/%E3%82%A4%E3%83%B3%E3%83%99%E3%83%B3%E3%83%88%E3%83%AA%E8%A8%AD%E8%A8%88.jpg 315w,\n/static/ecf23d3e43543dbffdc25988c10376ab/828fb/%E3%82%A4%E3%83%B3%E3%83%99%E3%83%B3%E3%83%88%E3%83%AA%E8%A8%AD%E8%A8%88.jpg 630w,\n/static/ecf23d3e43543dbffdc25988c10376ab/0ede0/%E3%82%A4%E3%83%B3%E3%83%99%E3%83%B3%E3%83%88%E3%83%AA%E8%A8%AD%E8%A8%88.jpg 945w,\n/static/ecf23d3e43543dbffdc25988c10376ab/3ac88/%E3%82%A4%E3%83%B3%E3%83%99%E3%83%B3%E3%83%88%E3%83%AA%E8%A8%AD%E8%A8%88.jpg 1260w,\n/static/ecf23d3e43543dbffdc25988c10376ab/e7cb9/%E3%82%A4%E3%83%B3%E3%83%99%E3%83%B3%E3%83%88%E3%83%AA%E8%A8%AD%E8%A8%88.jpg 1367w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>トップダウン設計によるメリット</h3>\n<p>トップダウン設計のメリットは単に可読性が上がり、スケーラビリティが高くなるだけではありません。コマンド実行が非常に簡単で運用も楽になります。Ansible には実際には沢山のオプションがあります。コマンド実行時にそれらを適切に付与してやる必要がありますが、トップダウン設計によってオプションもシンプルで簡単になります。</p>\n<p>例えば、以下のようになります。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># ansible-playbook site.yml</code></pre></div>\n<p>これは、Playbook の総本山である<code class=\"language-text\">site.yml</code>をホストの制限なく実行されています。<code class=\"language-text\">site.yml</code>に指定されているホストは<code class=\"language-text\">all</code>です。また、<code class=\"language-text\">site.yml</code>は<code class=\"language-text\">linux-common.yml</code>、<code class=\"language-text\">manager.yml</code>、<code class=\"language-text\">staging.yml</code>、<code class=\"language-text\">production.yml</code>を import していますから、結果的に<strong>必要なインフラが全て揃う</strong>コマンドということになります。</p>\n<p>以下はどうでしょうか？</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># ansible-playbook site.yml -l staging</code></pre></div>\n<p><code class=\"language-text\">-l</code>オプションは、ホストやグループを制限するオプションです。上の例では、<code class=\"language-text\">staging</code>グループに制限して<code class=\"language-text\">site.yml</code>を実行しています。実際には、<code class=\"language-text\">site.yml</code>を実行するのにはたとえ変更が全く無かったとしてもそれなりの時間を要します為、ホストやグループを制限して実行するのが普通です。しっかりとトップダウンで設計されていれば、Playbook は常に<code class=\"language-text\">site.yml</code>を指定して実行することができ、各種 Playbook を指定して実行することもできますがその必要がなくなります。これが最大のメリットです。</p>\n<p>また、次の例も見てみましょう。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># ansible-playbook site.yml -l staging --tags httpd</code></pre></div>\n<p>この例では、httpd という<code class=\"language-text\">role</code>を指定して実行しています。<code class=\"language-text\">role</code>は<code class=\"language-text\">tag</code>でタグ付けしています。コマンド実行時に<code class=\"language-text\">--tags</code>で指定した<code class=\"language-text\">role</code>を実行することができます。このようにすることで<code class=\"language-text\">role</code>の局所的使用を可能にします。</p>\n<p>まとめると、以下のようなコマンドで Playbook を実行することができます。</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># ansible-playbook site.yml &lt; -l (指定したターゲット) > &lt; --tags (role名) ></code></pre></div>\n<p>トップダウン設計することで、Playbook の実行コマンドがシンプルになりました。</p>\n<h3>ドライランチェック</h3>\n<p>ドライランチェックには、<code class=\"language-text\">ansible-playbook site.yml --check</code>のように、<code class=\"language-text\">--check</code>をオプションとして付与して実行します。\r\nPlaybook を実行する前に、冪等性のチェックと同様にドライランチェックを実行しましょう。\r\nドライランチェックを実行した際に問題が無いような Playbook の設計をしましょう。</p>\n<h3>冪等性</h3>\n<p>Playbook が冪等性が保たれていることを確認するために、最も簡単な方法は Playbook を二度実行して変更箇所が無いかどうか確認することです。\r\nただし、これはサーバの設定変更が反映されてしまいます。冪等性を確認するために Ansible が用意してくれているツールがあります。それが、<code class=\"language-text\">Ansible Molecule</code>です。</p>\n<p><code class=\"language-text\">Molecule</code>では、<code class=\"language-text\">Role</code>の開発支援とテスト自動化を行うことが出来るツールで、テストの部分に注目すると以下のテストを行えるとされている。</p>\n<ul>\n<li>Lint チェック</li>\n<li>Docker 内での Playbook 実行</li>\n<li>冪等性チェック</li>\n<li>テストコードの実行</li>\n</ul>\n<p>Ansible Molecule の使い方については、別のページで詳しく書くことにしますが品質を考えるとこれは便利そうです。</p>\n<h3>変数の設計</h3>\n<p>Playbook では、Vars セクションに限らず、様々なところで変数を定義することが出来ます。他の多くのプログラミング言語と同じく、スコープが狭い変数のほうが優先度が高い（＝上書きされる）特徴があります。</p>\n<p>参照範囲は 3 つのスコープに分かれます。</p>\n<ul>\n<li>\n<p>Global 領域</p>\n<ul>\n<li>環境変数(environment vars)</li>\n<li>エキストラ変数(extra vars)</li>\n</ul>\n</li>\n<li>\n<p>Play 単位</p>\n<ul>\n<li>プレイ変数(play vars)</li>\n<li>タスク変数(task vars)</li>\n<li>ロール変数(role vars)</li>\n</ul>\n</li>\n<li>\n<p>Host 単位</p>\n<ul>\n<li>インベントリ変数(inventory vars)</li>\n<li>ファクト変数(host facts)</li>\n<li>レジスタ変数(registered vars)</li>\n</ul>\n</li>\n</ul>\n<p>変数をどこで定義しているかで Playbook 自体の汎用性も変わってきます。ホストやグループに紐づく変数はインベントリ変数、role は汎用的に定義して Playbook の方でタスク変数としてロールのデフォルト変数を上書きするなどの工夫が必要です。実際には何が正解ということはないですが、上で書いたようなことを意識した上で汎用性の高い Playbook を設計しましょう。</p>\n<h3>内部リンク</h3>\n<h3>参考</h3>\n<ul>\n<li><a href=\"https://dev.classmethod.jp/articles/ansible-molecule/\" target=\"_blank\" rel=\"noopener\">Ansible のテストツール Molecule でできること</a></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"></code></pre></div>","frontmatter":{"title":"メンテナンスしやすいAnsiblePlaybookの書き方","date":"July 06, 2022","description":"メンテナンスしやすいAnsiblePlaybookの書き方"}},"previous":{"fields":{"slug":"/posted_20220703/"},"frontmatter":{"title":"Moff animal cafe イーアス高尾に行ってきました。"}},"next":null},"pageContext":{"id":"73a92fff-f448-5935-9577-b52c615aba39","previousPostId":"1ff0b549-65dc-581c-a223-82d5f5d6d7eb","nextPostId":null}},"staticQueryHashes":["2841359383","3257411868"]}